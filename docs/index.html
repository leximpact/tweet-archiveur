---

title: Tweet Archiveur


keywords: fastai
sidebar: home_sidebar

summary: "This project aim at storing tweets in a database. But you could use it without database."
description: "This project aim at storing tweets in a database. But you could use it without database."
nb_path: "notebooks/index.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: notebooks/index.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Input : tweetos id in a CSV file</li>
<li>Output : A databases of tweets and hastags</li>
</ul>
<p>The goal for us is to store tweets of all members of the French Parliament to get an idea of the trendings topics.</p>
<p>But you could use the project for other purpose with other people.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-install-the-package">How to install the package<a class="anchor-link" href="#How-to-install-the-package"> </a></h2><p>TODO : push it to Pipy when :</p>
<ul>
<li>Rename "nom" to name in users</li>
<li>reactivate unit tests (<a href="https://docs.github.com/en/actions/guides/creating-postgresql-service-containers">https://docs.github.com/en/actions/guides/creating-postgresql-service-containers</a>)</li>
<li>Made scrapper a Class</li>
<li>Switch to SQL Alchemy</li>
<li>Flake8</li>
<li>Documentation</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>pip install tweetarchiveur</code></p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-to-use-the-package-in-your-project">How to use the package in your project<a class="anchor-link" href="#How-to-use-the-package-in-your-project"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>There is two class :</p>
<ul>
<li>A Scrapper() to use the Twitter API</li>
<li>A Database() to store tweets and hastags in it</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">tweet_archiveur.scrapper</span> <span class="k">import</span> <span class="n">Scrapper</span>
<span class="kn">from</span> <span class="nn">tweet_archiveur.database</span> <span class="k">import</span> <span class="n">Database</span>

<span class="c1"># Force some variable outside Docker</span>
<span class="kn">from</span> <span class="nn">os</span> <span class="k">import</span> <span class="n">environ</span>
<span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DATABASE_PORT&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;8479&#39;</span>
<span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DATABASE_HOST&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;localhost&#39;</span>
<span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DATABASE_USER&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;tweet_archiveur_user&#39;</span>
<span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DATABASE_PASS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;1234leximpact&#39;</span>
<span class="n">environ</span><span class="p">[</span><span class="s2">&quot;DATABASE_NAME&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;tweet_archiveur&#39;</span>

<span class="n">scrapper</span> <span class="o">=</span> <span class="n">Scrapper</span><span class="p">()</span>
<span class="n">df_users</span> <span class="o">=</span> <span class="n">scrapper</span><span class="o">.</span><span class="n">get_users_accounts</span><span class="p">(</span><span class="s1">&#39;../tests/sample-users.csv&#39;</span><span class="p">)</span>
<span class="n">users_id</span> <span class="o">=</span> <span class="n">df_users</span><span class="o">.</span><span class="n">twitter_id</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">database</span> <span class="o">=</span> <span class="n">Database</span><span class="p">()</span>
<span class="n">database</span><span class="o">.</span><span class="n">create_tables_if_not_exist</span><span class="p">()</span>
<span class="n">database</span><span class="o">.</span><span class="n">insert_twitter_users</span><span class="p">(</span><span class="n">df_users</span><span class="p">)</span>
<span class="n">scrapper</span><span class="o">.</span><span class="n">get_all_tweet_and_store_them</span><span class="p">(</span><span class="n">database</span><span class="p">,</span> <span class="n">users_id</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
<span class="k">del</span> <span class="n">database</span>
<span class="k">del</span> <span class="n">scrapper</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>2021-03-22 10:21:59,837 -  tweet-archiveur INFO     Scrapper ready
2021-03-22 10:21:59,841 -  tweet-archiveur INFO     Loading database module...
2021-03-22 10:21:59,842 -  tweet-archiveur DEBUG    DEBUG : connect(user=tweet_archiveur_user, password=XXXX, host=localhost, port=8479, database=tweet_archiveur, url=None)
2021-03-22 10:22:03,915 -  tweet-archiveur INFO     Done scrapping, we got 400 tweets from 2 tweetos.
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="How-we-use-it">How we use it<a class="anchor-link" href="#How-we-use-it"> </a></h2><p>We get the tweets of the 577 French Parliament member's every 8 hours and store them in a PostgreSQL database.</p>
<p>We then explore them with Apache Superset.</p>
<h3 id="How-we-deploy-it">How we deploy it<a class="anchor-link" href="#How-we-deploy-it"> </a></h3><p>Prepare the environment :</p>
<div class="highlight"><pre><span></span>git clone https://github.com/leximpact/tweet-archiveur.git
<span class="nb">cd</span> tweet-archiveur
cp docker/docker.env .env
</pre></div>
<p>Edit the <em>.env</em> to your needs.</p>
<p>Run the application :</p>
<div class="highlight"><pre><span></span>docker-compose up -d
</pre></div>
<p>To view what's going on :</p>
<div class="highlight"><pre><span></span>docker logs tweet-archiveur_tweet_archiveur_1 -f
</pre></div>
<p>The script <em>archiveur.py</em> use the package to get the parliament accounts from <a href="https://github.com/regardscitoyens/twitter-parlementaires">https://github.com/regardscitoyens/twitter-parlementaires</a></p>
<p>The parameters is read in a <em>.env</em> file.</p>
<p>It is launched by the <em>entrypoint.sh</em> script every 8 hours.</p>
<p>To stop it :</p>
<div class="highlight"><pre><span></span>docker-compose down
</pre></div>
<p>The data is kept in a docker volume, to clean them :</p>
<div class="highlight"><pre><span></span>docker-compose down -v
</pre></div>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="What-to-do-with-it-?">What to do with it ?<a class="anchor-link" href="#What-to-do-with-it-?"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<ul>
<li>Most used hashtag (per period, per person)</li>
<li>Most/Less active user</li>
<li>Timeline of </li>
<li>NLP Topic detection</li>
<li>Word cloud</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h1 id="Annexes">Annexes<a class="anchor-link" href="#Annexes"> </a></h1><p>Exit code :</p>
<ul>
<li>1 : Unknown error when storing tweets</li>
<li>2 : Unknown error getting tweets</li>
<li>3 : Failed more than 3 consecutive times</li>
<li>4 : no env</li>
</ul>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If one thing fail no tweet will be saved.</p>
<p>status code = 429 : 429 'Too many requests' error is returned when you exceed the maximum number of requests allowed</p>

</div>
</div>
</div>
</div>
 

